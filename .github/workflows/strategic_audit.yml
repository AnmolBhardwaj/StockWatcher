name: Strategic Sector Audit Cron

on:
  schedule:
    # MARKET HOURS: Runs every 30 mins from 3:45 AM UTC to 10:15 AM UTC (approx 9:15-3:45 IST)
    # 1-5 = Monday to Friday
    - cron: '15,45 3-10 * * 1-5'

    # NEWS WINDOWS: 6am, 3pm, 8pm, 12am IST
    - cron: '30 0,9,14,18 * * *'
    
  workflow_dispatch: # Keep for manual testing

jobs:
  audit_and_poll:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicitly allow writing to the repo
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance feedparser groq google-generativeai

      - name: Execute Strategic Pipeline
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # 1. Price Fetch (Will only run on the 30-min cron triggers)
          python scripts/stock_api.py
          # 2. News Fetch
          python scripts/news_api.py
          # 3. Groq Brain Audit
          python main.py

      - name: Persist Data Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add data/*.json price_list.json
          git diff-index --quiet HEAD || (git commit -m "Update strategic data [skip ci]" && git push)